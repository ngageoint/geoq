{% extends "core/base.html" %}
{% load compress %}
{% load leaflet_tags %}
{% load geoserver_job_link %}
{% block title %}GeoQ Assign workcells: {{ object.name }}{% endblock %}
{% block static_libraries %}
{% leaflet_js plugins="draw" %}
{% compress css %}
{% leaflet_css plugins="draw"%}
{% endcompress %}
    <link rel="stylesheet" href="{{ STATIC_URL }}css/theme.blue.min.css" />
    <link rel="stylesheet" href="{{ STATIC_URL }}css/tablesorter-highlight.css" />
    <script src="{{ STATIC_URL }}core/js/leaflet_helper.js"></script>
    <script src="{{ STATIC_URL }}bootstrap/js/bootstrap-dialog.js"></script>
    <script src="{{ STATIC_URL }}core/js/maths.js"></script>
    <script src="{{ STATIC_URL }}core/js/polygon.js"></script>
    <script src="{{ STATIC_URL }}js/jquery.tablesorter.combined.min.js"></script>
    <script src="{{ STATIC_URL }}js/widget-scroller.min.js"></script>
    <script src="{{ STATIC_URL }}leaflet/leaflet-plugins/leaflet.shapefile-gh-pages/leaflet.shpfile.js" type="text/javascript"></script>
    <script src="{{ STATIC_URL }}leaflet/leaflet-plugins/leaflet.shapefile-gh-pages/shp.js" type="text/javascript"></script>

    <script src="{{ STATIC_URL }}core/js/job_map.js"></script>

<style>
    table th:nth-child(2),
    table td:nth-child(2) {
        display: none;
    }
    .markerlabelClass{
        white-space: nowrap;
        text-shadow: 0 0 0.1em black, 0 0 0.1em black, 0 0 0.1em black, 0 0 0.1em black, 0 0 0.1em;
        color: yellow;
    }
</style>

<script type="application/javascript">
    job_map.groups_url = "{% url 'list_groups' object.id %}";
    job_map.home_url = "{% url 'home' %}";
    job_map.data = {{ object.geoJSON|default:'[]'|safe }};
    job_map.popup_template = '{% filter escapejs %}{% include "core/assign_workcell_popup.html" %}{% endfilter %}';
    job_map.token = "{{ csrf_token }}";
    job_map.url = '{{ job_properties.delete_url }}';

    var map_layers = {{ object.map.to_json|safe|default:"{}" }};


    $(function() {
        $(".tablesorter")
                .tablesorter({
                    theme: 'blue',
                    cssChildRow: 'tablesorter-childRow',
                    widgets: ['zebra', 'filter', 'scroller'],
                    headers: {
                        0: {
                            sorter: 'checkbox'
                        }
                    },
                    widgetOptions: {
                        filter_childRows: true,
                        filter_cssFilter: 'tablesorter-filter',
                        filter_startsWith: false,
                        filter_ignoreCase: true
                    }
                });

        $('.tablesorter-childRow td').hide();

        $('.tablesorter').delegate('.toggle', 'click', function() {
            $(this).closest('tr').nextUntil('tr.tablesorter-hasChildRow').find('td').toggle();

            return false;
        });

        $('.tablesorter').addClass('focus-highlight');

        if ( $('.focus-highlight').length ) {
            $('.focus-highlight').find('td, th')
                    .attr('tabindex', '1')
                    .on('touchstart', function() {
                        $(this).focus();
                    });
        }

        $('button.toggle-option').click(function() {
            var c = $('.tablesorter')[1].config.widgetOptions,
                    o = !c.filter_childRows;
            c.filter_childRows = o;
            $('.state').html(o.toString());
            $('table').trigger('search', false);
            return false;
        });
    });


</script>

    {% compress css %}
    {% leaflet_css %}
    <link href="{{ STATIC_URL }}core/less/geoq.less" media="all" rel="stylesheet" type="text/less" />
{% endcompress %}
{% endblock %}

{% block container %}
    <div class="row-fluid container">

        <div class="projectlist">

            {% include 'core/_job_stat_list.html' %}

            <h3>
                <span class="title header">
                    <a href="{%url 'job-detail' object.id %}">{{ object.name }} - Assign Workcells</a>
                </span>
            </h3>

            <p class="body project-description">
                {{ object.description }}
            </p>

            <div class="row body" style="height:500px; margin-top:25px">
                <div class="span4 thumbnail" id="map" style="height:450px; width: 850px; vertical-alignment:middle;">
                {% leaflet_map "map" creatediv=False%}
                </div>
            </div>
            <div class="row body">
                <div id="workcells" class="row-fluid">
                    <div id="c_form" style="margin-left: 0" class="span9 offset1">
                        <table class="tablesorter" id="workcell-list">
                            <colgroup>
                                <col width="5%" />
                                <col width="15%" />
                                <col width="15%" />
                                <col width="15%" />
                                <col width="25%" />
                                <col width="20%" />
                            </colgroup>
                            <thead>
                            <tr>
                                <th><input id="batch-assign-workcells" type="checkbox" onclick="job_map.check_all();"></th>
                                <th>ID</th>
                                <th>ATC ID</th>
                                <th>Size</th>
                                <th>Status</th>
                                <th>Assigned To</th>
                                <th>Analyst</th>
                            </tr>
                            </thead>
                            <tbody>
                            </tbody>
                        </table>

                    </div><!-- end c_form -->
                </div><!-- end contact -->
            </div>

        {% if not workcell_count %}
            <div class="row body">
            {% if 'accounts.add_job' in request.base_perms %}
                <span><b>No workcells. Next step: </b> <a class="btn btn-large btn-success" href="{% url 'job-create-aois' job_pk=object.id %}">Create workcells</a></span>
            {% else %}
                <span><b>This Job doesn't have any workcells yet, please ask a supervisor to create some</b></span>
            {% endif %}
            </div>
        {% endif %}

        </div>

    </div>
    <div class="row-fluid container-narrow" style="margin-bottom: 25px;">
        <div class="row body">
            <div class="btn-toolbar offset3">
                <a class="btn btn-primary" href="javascript:job_map.assignAOI([]);">Assign Workcells</a>
                <a class="btn btn-primary" href="javascript:job_map.assignAOI([])">Assign Workcells and Close</a>
                <a class="btn btn-primary" href="{% url 'job-detail' object.id %}">Return</a>
            </div>
        </div>
    </div>
{% endblock %}

